(function(){function u(e){var t=parseInt(e);var n='<div class="progress"><div class="progress-bar" style="width: '+t+'%"></div></div>';return n}function v(e){var t=parseInt(e);return App.formatBytes(t)}function h(e){var t,n;switch(e){case"Completed":t="ok-circle text-success";break;case"Running":t="play-circle text-info";break;case"Stopped":t="ban-circle text-warning";break;case"Failed":t="remove-circle text-danger";break;default:e="Stopped";t="ban-circle text-warning"}n=states[e];return'<span class="glyphicon glyphicon-'+t+'" title="'+n+'"></span>'}function k(e){return v(e)+"/s"}var n,g,a=BACKEND_URL+"/download";function e(e,t){if(n){if(e!=null)e();return false}n=new SockJS(a+"/progress");n.onopen=function(){if(e!=null)e()};n.onclose=function(){n=null};n.onmessage=function(e){if(t!=null)t(e.data)}}function b(){if(g){window.clearInterval(g);g=null}if(n){n.close();n=null}}function t(){var d=$("#tr-template").html();e(function(){n.send("progress")},function(e){var t=JSON.parse(e);var n=100*t.length,r=0;var a=$("#fileTable .allCheck").prop("checked");for(var i=0;i<t.length;i++){var o=t[i];if(o.State!="Running"){r+=100}else{r+=o.Progress}if($("#id-"+o.Id).length>0){$("#downed-"+o.Id).text(v(o.Downloaded));$("#percent-"+o.Id).text(o.Progress);$("#speed-"+o.Id).text(k(o.Speed));$("#progress-"+o.Id).html(u(o.Progress));$("#state-"+o.Id).html(h(o.State));continue}var s=d;for(var c in o){var l=new RegExp("\\{"+c+"\\}","g");var p=o[c];switch(c){case"Downloaded":p=v(p);break;case"Size":p=p=="-1"?"unknown":v(p);break;case"Speed":p=k(p);break;case"FileName":p='<span id="state-'+o.Id+'">'+h(o.State)+"</span> "+p;break;case"Progress":var f=new RegExp("\\{Percent\\}");s=s.replace(f,p);p=u(p);break}s=s.replace(l,p)}if(a){s=$(s);s.find(".idCheck").prop("checked",true)}$("#fileList").append(s)}if(g&&n<=r){b()}})}function i(){if(g)return;if(!n){t()}else{n.send("progress")}g=setInterval(function(){if(!n){window.clearInterval(g);return}n.send("progress")},2e3)}function r(e,t,n){y(false);var r={contentType:"application/json; charset=utf-8",url:a+e,type:"POST",dataType:"json"};if(t)r.data=JSON.stringify(t);$.ajax(r).error(function(e){y(true);console.dir(e)}).success(function(e){y(true);if(e.Code!=1){App.message({text:e.Info,type:"error"},false);return}if(n)n();i()})}function o(e,t,n){y(false);var r={url:a+e,type:"POST",dataType:"json"};if(t)r.data=t;$.ajax(r).error(function(e){y(true);alert(e)}).success(function(e){y(true);if(e.Code!=1){App.message({text:e.Info,type:"error"},false);return}if(n)n();i()})}function s(){var e={PartCount:parseInt($("#part_count_id").val()),FilePath:$("#save_path_id").val(),Url:$("#url_id").val(),Download:$("#dlopt-download-now").prop("checked")};e.Pipes=[];$('#select-option-pipes input[name="pipes[]"]:checked').each(function(){e.Pipes.push($(this).val())});r("/add_task",e)}function c(){var e=[];$("#fileTable .idCheck:checked").each(function(){e.push(parseInt($(this).val()))});return e}function l(){$("#fileTable .idCheck:checked").prop("checked",false)}function p(){var t={id:c()};o("/remove_task",t,function(){for(var e=0;e<t.id.length;e++){$("#id-"+t.id[e]).parent("tr").remove()}})}function f(){var e={id:c()};o("/start_task",e,l)}function d(){var e={id:c()};o("/restart_task",e,l)}function w(){var e={id:c()};o("/stop_task",e,l)}function m(){r("/start_all_task")}function x(){r("/stop_all_task")}function _(){var e=$("#url_id").val().split("?")[0].split("/").pop();$("#save_path_id").val(e);var t=e.split(".").pop();if(!t){$("#select-option-pipes").empty();$("#select-pipes").hide();return}t="."+t.toLowerCase();var n="";for(var r in pipes){var a=pipes[r];for(var i=0;i<a.Extensions.length;i++){var o=a.Extensions[i];if(o==t){n+='<div class="checkbox checkbox-primary checkbox-inline"><input type="checkbox" name="pipes[]" value="'+r+'" id="opt-pipes-'+r+'"><label for="opt-pipes-'+r+'">'+a.Label+"</label></div>"}}}if(n.length>0){$("#select-option-pipes").html(n);$("#select-pipes").show()}else{$("#select-option-pipes").empty();$("#select-pipes").hide()}}function y(e){App.loading(e?"hide":"show")}$(function(){i();$("body").on("click","#fileTable .allCheck",function(){$("#fileTable .idCheck").prop("checked",$(this).prop("checked"))});_();$("#url_id").off().on("change",_);$("#dlctrl-remove").off().on("click",p);$("#dlctrl-start").off().on("click",f);$("#dlctrl-stop").off().on("click",w);$("#dlctrl-restart").off().on("click",d);$("#dlctrl-start-all").off().on("click",m);$("#dlctrl-stop-all").off().on("click",x);$("#dlctrl-add").off().on("click",s)})})();