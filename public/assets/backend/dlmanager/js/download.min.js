(function(){function u(e){var t=parseInt(e);var n='<div class="progress"><div class="progress-bar" style="width: '+t+'%"></div></div>';return n}function v(e){var t=parseInt(e);return App.formatBytes(t)}function h(e){var t,n;switch(e){case"Completed":t="ok-circle text-success";break;case"Running":t="play-circle text-info";break;case"Stopped":t="ban-circle text-warning";break;case"Failed":t="remove-circle text-danger";break;default:e="Stopped";t="ban-circle text-warning"}n=states[e];return'<span class="glyphicon glyphicon-'+t+'" title="'+n+'"></span>'}function k(e){return v(e)+"/s"}var n,g,r=BACKEND_URL+"/download";function e(e,t){if(n){if(e!=null)e();return false}n=new SockJS(r+"/progress");n.onopen=function(){if(e!=null)e()};n.onclose=function(){n=null};n.onmessage=function(e){if(t!=null)t(e.data)}}function b(){if(g){window.clearInterval(g);g=null}if(n){n.close();n=null}}function t(){var f=$("#tr-template").html();e(function(){n.send("progress")},function(e){var t=JSON.parse(e);var n=100*t.length,a=0;var r=$("#fileTable .allCheck").prop("checked");for(var i=0;i<t.length;i++){var s=t[i];if(s.State!="Running"){a+=100}else{a+=s.Progress}if($("#id-"+s.Id).length>0){$("#downed-"+s.Id).text(v(s.Downloaded));$("#percent-"+s.Id).text(s.Progress);$("#speed-"+s.Id).text(k(s.Speed));$("#progress-"+s.Id).html(u(s.Progress));$("#state-"+s.Id).html(h(s.State));continue}var c=f;for(var o in s){var l=new RegExp("\\{"+o+"\\}","g");var p=s[o];switch(o){case"Downloaded":p=v(p);break;case"Size":p=p=="-1"?"unknown":v(p);break;case"Speed":p=k(p);break;case"FileName":p='<span id="state-'+s.Id+'">'+h(s.State)+"</span> "+p;break;case"Progress":var d=new RegExp("\\{Percent\\}");c=c.replace(d,p);p=u(p);break}c=c.replace(l,p)}if(r){c=$(c);c.find(".idCheck").prop("checked",true)}$("#fileList").append(c)}if(g&&n<=a){b()}})}function i(){if(g)return;if(!n){t()}else{n.send("progress")}g=setInterval(function(){if(!n){window.clearInterval(g);return}n.send("progress")},2e3)}function a(e,t,n){y(false);var a={contentType:"application/json; charset=utf-8",url:r+e,type:"POST",dataType:"json"};if(t)a.data=JSON.stringify(t);$.ajax(a).error(function(e){y(true);console.dir(e)}).success(function(e){y(true);if(e.Code!=1){App.message({text:e.Info,type:"error"},false);return}if(n)n();i()})}function s(e,t,n){y(false);var a={url:r+e,type:"POST",dataType:"json"};if(t)a.data=t;$.ajax(a).error(function(e){y(true);alert(e)}).success(function(e){y(true);if(e.Code!=1){App.message({text:e.Info,type:"error"},false);return}if(n)n();i()})}function c(){var e={PartCount:parseInt($("#part_count_id").val()),FilePath:$("#save_path_id").val(),Url:$("#url_id").val(),Download:$("#dlopt-download-now").prop("checked")};e.Pipes=[];$('#select-option-pipes input[name="pipes[]"]:checked').each(function(){e.Pipes.push($(this).val())});a("/add_task",e)}function o(){var e=[];$("#fileTable .idCheck:checked").each(function(){e.push(parseInt($(this).val()))});return e}function l(){$("#fileTable .idCheck:checked").prop("checked",false)}function p(){var t={id:o()};s("/remove_task",t,function(){for(var e=0;e<t.id.length;e++){$("#id-"+t.id[e]).parent("tr").remove()}})}function d(){var e={id:o()};s("/start_task",e,l)}function f(){var e={id:o()};s("/restart_task",e,l)}function w(){var e={id:o()};s("/stop_task",e,l)}function _(){a("/start_all_task")}function m(){a("/stop_all_task")}function x(){var e=$("#url_id").val().split("?")[0].split("/").pop();$("#save_path_id").val(e);var t=e.split(".").pop();if(!t){$("#select-option-pipes").empty();$("#select-pipes").hide();return}t="."+t.toLowerCase();var n="";for(var a in pipes){var r=pipes[a];for(var i=0;i<r.Extensions.length;i++){var s=r.Extensions[i];if(s==t){n+='<div class="checkbox checkbox-primary checkbox-inline"><input type="checkbox" name="pipes[]" value="'+a+'" id="opt-pipes-'+a+'"><label for="opt-pipes-'+a+'">'+r.Label+"</label></div>"}}}if(n.length>0){$("#select-option-pipes").html(n);$("#select-pipes").show()}else{$("#select-option-pipes").empty();$("#select-pipes").hide()}}function y(e){App.loading(e?"hide":"show")}$(function(){App.loading("hide");i();App.searchFS("#save_path_id",20);$("body").on("click","#fileTable .allCheck",function(){$("#fileTable .idCheck").prop("checked",$(this).prop("checked"))});x();$("#url_id").on("change",x);$("#dlctrl-remove").on("click",p);$("#dlctrl-start").on("click",d);$("#dlctrl-stop").on("click",w);$("#dlctrl-restart").on("click",f);$("#dlctrl-start-all").on("click",_);$("#dlctrl-stop-all").on("click",m);$("#dlctrl-add").on("click",c)})})();