(function(){function u(e){var t=parseInt(e);var n='<div class="progress"><div class="progress-bar" style="width: '+t+'%"></div></div>';return n}function h(e){var t=parseInt(e);return App.formatBytes(t)}function v(e){var t,n;switch(e){case"Completed":t="ok-circle text-success";break;case"Running":t="play-circle text-info";break;case"Stopped":t="ban-circle text-warning";break;case"Failed":t="remove-circle text-danger";break;default:e="Stopped";t="ban-circle text-warning"}n=states[e];return'<span class="glyphicon glyphicon-'+t+'" title="'+n+'"></span>'}function k(e){return h(e)+"/s"}var n,g,a=BACKEND_URL+"/download";function e(e,t){if(n){if(e!=null)e();return false}n=new SockJS(a+"/progress");n.onopen=function(){if(e!=null)e()};n.onclose=function(){n=null};n.onmessage=function(e){if(t!=null)t(e.data)}}function w(){if(g){window.clearInterval(g);g=null}if(n){n.close();n=null}}function t(){var f=$("#tr-template").html();e(function(){n.send("progress")},function(e){var t=JSON.parse(e);var n=100*t.length,r=0;var a=$("#fileTable .allCheck").prop("checked");for(var i=0;i<t.length;i++){var s=t[i];if(s.State!="Running"){r+=100}else{r+=s.Progress}if($("#id-"+s.Id).length>0){$("#downed-"+s.Id).text(h(s.Downloaded));$("#percent-"+s.Id).text(s.Progress);$("#speed-"+s.Id).text(k(s.Speed));$("#progress-"+s.Id).html(u(s.Progress));$("#state-"+s.Id).html(v(s.State));continue}var c=f;for(var l in s){var o=new RegExp("\\{"+l+"\\}","g");var p=s[l];switch(l){case"Downloaded":p=h(p);break;case"Size":p=p=="-1"?"unknown":h(p);break;case"Speed":p=k(p);break;case"FileName":p='<span id="state-'+s.Id+'">'+v(s.State)+"</span> "+p;break;case"Progress":var d=new RegExp("\\{Percent\\}");c=c.replace(d,p);p=u(p);break}c=c.replace(o,p)}if(a){c=$(c);c.find(".idCheck").prop("checked",true)}$("#fileList").append(c)}if(g&&n<=r){w()}})}function i(){if(g)return;if(!n){t()}else{n.send("progress")}g=setInterval(function(){if(!n){window.clearInterval(g);return}n.send("progress")},2e3)}function r(e,t,n){_(false);var r={contentType:"application/json; charset=utf-8",url:a+e,type:"POST",dataType:"json"};if(t)r.data=JSON.stringify(t);$.ajax(r).error(function(e){_(true);console.dir(e)}).success(function(e){_(true);if(e.Code!=1){App.message({text:e.Info,type:"error"},false);return}if(n)n();i()})}function s(e,t,n){_(false);var r={url:a+e,type:"POST",dataType:"json"};if(t)r.data=t;$.ajax(r).error(function(e){_(true);alert(e)}).success(function(e){_(true);if(e.Code!=1){App.message({text:e.Info,type:"error"},false);return}if(n)n();i()})}function c(){var e={PartCount:parseInt($("#part_count_id").val()),FilePath:$("#save_path_id").val(),Url:$("#url_id").val(),Download:$("#dlopt-download-now").prop("checked")};e.Pipes=[];$('#select-option-pipes input[name="pipes[]"]:checked').each(function(){e.Pipes.push($(this).val())});r("/add_task",e)}function l(){var e=[];$("#fileTable .idCheck:checked").each(function(){e.push(parseInt($(this).val()))});return e}function o(){var e=$("#fileTable");e.find(".idCheck:checked").prop("checked",false);e.find(".allCheck:checked").prop("checked",false)}function p(){var t={id:l()};if(t.id.length<1)return App.message({text:App.t("请选择要删除的下载任务"),type:"warn"});s("/remove_task",t,function(){for(var e=0;e<t.id.length;e++){$("#id-"+t.id[e]).parent("tr").remove()}})}function d(){var e={id:l()};if(e.id.length<1)return App.message({text:App.t("请选择要开始的下载任务"),type:"warn"});s("/start_task",e,o)}function f(){var e={id:l()};if(e.id.length<1)return App.message({text:App.t("请选择要重新开始的下载任务"),type:"warn"});s("/restart_task",e,o)}function b(){var e={id:l()};if(e.id.length<1)return App.message({text:App.t("请选择要停止的下载任务"),type:"warn"});s("/stop_task",e,o)}function m(){r("/start_all_task")}function x(){r("/stop_all_task")}function y(){var e=$("#url_id").val().split("?")[0].split("/").pop();$("#save_path_id").val(e);var t=e.split(".").pop();if(!t){$("#select-option-pipes").empty();$("#select-pipes").hide();return}t="."+t.toLowerCase();var n="";for(var r in pipes){var a=pipes[r];for(var i=0;i<a.Extensions.length;i++){var s=a.Extensions[i];if(s==t){n+='<div class="checkbox checkbox-primary checkbox-inline"><input type="checkbox" name="pipes[]" value="'+r+'" id="opt-pipes-'+r+'"><label for="opt-pipes-'+r+'">'+a.Label+"</label></div>"}}}if(n.length>0){$("#select-option-pipes").html(n);$("#select-pipes").show()}else{$("#select-option-pipes").empty();$("#select-pipes").hide()}}function _(e){App.loading(e?"hide":"show")}$(function(){App.loading("hide");i();App.searchFS("#save_path_id",20);$("body").on("click","#fileTable .allCheck",function(){$("#fileTable .idCheck").prop("checked",$(this).prop("checked"))});y();$("#url_id").on("change",y);$("#dlctrl-remove").on("click",p);$("#dlctrl-start").on("click",d);$("#dlctrl-stop").on("click",b);$("#dlctrl-restart").on("click",f);$("#dlctrl-start-all").on("click",m);$("#dlctrl-stop-all").on("click",x);$("#dlctrl-add").on("click",c)})})();